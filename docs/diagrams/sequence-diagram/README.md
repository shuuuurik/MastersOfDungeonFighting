## Диаграмма последовательностей: основные сценарии взаимодействия

Эта диаграмма последовательностей иллюстрирует **порядок взаимодействий** между ключевыми компонентами системы при выполнении основных игровых сценариев. Она фокусируется на двух важнейших потоках: **инициализации игры** и **обработке хода игрока (включая последующий ход врагов)**, демонстрируя, как вызовы методов и данные передаются между участниками.

### 1. Инициализация игры

Сценарий инициализации описывает шаги, происходящие при запуске игры:

* **Пользователь** инициирует запуск игры через **`App`**.
* **`App`** создает экземпляр **`GameEngine`**, который является центральным координатором игровой логики.
* **`GameEngine`** отвечает за создание игрового мира:
    * Использует **`MapBuilder`** для генерации игровой карты и определения текущего поля.
    * Применяет **`EntityManager`** для создания **игрока** и **всех врагов**, размещая их на поле.
    * Для реплицирующихся врагов создаются соответствующие объекты **`ReplicatingEntity`**.
    * Каждому врагу назначается его **`BehaviorStrategy`** и начальное **`NormalState`**.
* После завершения инициализации **`GameEngine`** возвращает текущее состояние игры в **`App`**, который затем отображает игровой мир **Пользователю**.

### 2. Ход игрока и обработка хода врагов

Этот сценарий показывает, как система реагирует на действие игрока и последующие действия врагов:

* **Пользователь** инициирует действие (например, нажатие стрелки) через **`App`**.
* **`App`** использует **`CommandInvoker`** для создания и выполнения соответствующей команды (**`MoveCommand`** в данном случае).
* **`MoveCommand`** вызывает метод `movePlayer()` в **`GameEngine`**.
* **`GameEngine`** выполняет проверки на валидность хода и запускает основной метод `processTurn()`, который обрабатывает всю логику текущего хода.
* В рамках `processTurn()`:
    * **`GameEngine`** вызывает метод `processEnemyTurns()`. Для каждого врага:
        * Определяется следующая позиция врага через его **`EnemyState`**.
        * **`EnemyState`** делегирует определение следующей позиции соответствующей **`BehaviorStrategy`**.
        * Выполняется потенциальный бой с игроком или обновление позиции врага.
    * Затем **`GameEngine`** обрабатывает репликацию: для каждого **`ReplicatingEntity`** вызывается `tryReplicate()`, и при успешной репликации создается новая сущность.
    * Наконец, **`GameEngine`** обновляет состояния врагов, проверяя, требуется ли переход в новое **`EnemyState`** (например, из `Normal` в `Panic`).
* После завершения обработки хода **`GameEngine`** возвращает обновленное **`gameState`** в **`App`**, который затем **обновляет пользовательский интерфейс** для **Пользователя**.